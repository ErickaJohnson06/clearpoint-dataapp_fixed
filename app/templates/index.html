
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ brand.APP_NAME }} â€” Enterprise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>:root{--brand: {{ brand.PRIMARY_HEX }};}</style>
</head>
<body class="bg-slate-950 text-slate-100">
<div class="max-w-6xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      {% if brand.LOGO_URL %}<img src="{{ brand.LOGO_URL }}" class="h-10 w-10 rounded-xl object-cover"/>{% else %}
      <div class="h-10 w-10 rounded-xl" style="background: var(--brand)"></div>{% endif %}
      <div><h1 class="text-2xl font-bold">{{ brand.APP_NAME }}</h1><p class="text-slate-400 text-sm -mt-0.5">{{ brand.TAGLINE }}</p></div>
    </div>
    <div class="flex items-center gap-2">
      <a href="/redact" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Redact docs</a>
      {% if user %}
        <form method="post" action="/logout"><button class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Logout</button></form>
      {% else %}
        <a href="/login" class="px-3 py-1 rounded-lg text-sm" style="background: var(--brand)">Sign in with Google</a>
      {% endif %}
      <a href="/docs" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">API Docs</a>
    </div>
  </header>

  <section class="grid md:grid-cols-3 gap-6">
    <div class="md:col-span-2 bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
      <h2 class="text-lg font-semibold mb-4">Process a CSV</h2>
      <form id="form" class="grid md:grid-cols-2 gap-4" enctype="multipart/form-data">
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold mb-1">CSV file</label>
          <input class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 text-white file:cursor-pointer rounded-lg bg-slate-950 border border-slate-800 p-2" type="file" name="file" accept=".csv" required />
          <p id="headersHint" class="text-xs text-slate-400 mt-1"></p>
        </div>
        <div><label class="block text-sm font-semibold mb-1">Email columns</label><input class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2" type="text" name="email_columns" placeholder="email,alt_email"/></div>
        <div><label class="block text-sm font-semibold mb-1">Phone columns</label><input class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2" type="text" name="phone_columns" placeholder="phone,cell"/></div>
        <div class="md:col-span-2"><label class="block text-sm font-semibold mb-1">Key columns for dedupe</label><input class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2" type="text" name="key_columns" placeholder="email,phone"/></div>
        <div class="md:col-span-2 flex flex-wrap gap-3">
          <button class="px-4 py-2 rounded-xl text-slate-900" type="submit" id="processBtn" style="background: var(--brand)">Process</button>
          <a id="downloadCsv" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" download="cleaned.csv">Download CSV</a>
          <button id="downloadXlsx" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" type="button">Download Excel</button>
          <button id="openReport" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" type="button">Open Report</button>
          <button id="printReport" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" type="button">Save as PDF</button>
        </div>
      </form>
      <div id="summary" class="hidden mt-6 bg-slate-950 border border-slate-800 rounded-xl p-4"></div>
      <div id="preview" class="hidden mt-6"><h3 class="font-semibold mb-2">Preview (first 10 rows)</h3><div class="overflow-auto border border-slate-800 rounded-xl">
        <table id="previewTable" class="min-w-full text-sm"><thead class="bg-slate-900"></thead><tbody class="divide-y divide-slate-900"></tbody></table></div></div>
    </div>
    <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4"><h2 class="text-lg font-semibold mb-4">Analytics (this device)</h2><canvas id="analyticsChart" height="260"></canvas></div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx=document.getElementById('analyticsChart'); const chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Invalid emails',data:[]},{label:'Invalid phones',data:[]},{label:'Duplicates removed',data:[]}]}});
const form=document.getElementById('form'); const headersHint=document.getElementById('headersHint'); const summaryBox=document.getElementById('summary'); const preview=document.getElementById('preview'); const tHead=document.querySelector('#previewTable thead'); const tBody=document.querySelector('#previewTable tbody'); const dlCsv=document.getElementById('downloadCsv'); const dlXlsx=document.getElementById('downloadXlsx'); const openReportBtn=document.getElementById('openReport'); const printReportBtn=document.getElementById('printReport');
form.file.addEventListener('change', async()=>{ if(!form.file.files[0]) return; const text=await form.file.files[0].text(); const firstLine=text.split(/\r?\n/)[0]||''; headersHint.textContent=firstLine ? 'Detected headers: '+firstLine : '' });
form.addEventListener('submit', async(e)=>{ e.preventDefault(); summaryBox.classList.add('hidden'); preview.classList.add('hidden'); const fd=new FormData(form); const res=await fetch('/api/process',{method:'POST',body:fd}); if(!res.ok){alert('Processing failed');return;} const data=await res.json(); const s=data.summary;
summaryBox.innerHTML=`<div class='grid grid-cols-2 md:grid-cols-3 gap-3 text-sm'>
<div><span class='text-slate-400'>Rows in</span><div class='text-xl font-semibold'>${s.rows_in}</div></div>
<div><span class='text-slate-400'>Rows out</span><div class='text-xl font-semibold'>${s.rows_out}</div></div>
<div><span class='text-slate-400'>Duplicates removed</span><div class='text-xl font-semibold'>${s.duplicates_removed}</div></div>
<div><span class='text-slate-400'>Invalid emails</span><div class='text-xl font-semibold'>${s.invalid_emails}</div></div>
<div><span class='text-slate-400'>Invalid phones</span><div class='text-xl font-semibold'>${s.invalid_phones}</div></div>
<div><span class='text-slate-400'>Columns</span><div class='text-sm break-all'>${(s.columns||[]).join(', ')}</div></div></div>`; summaryBox.classList.remove('hidden');
const blob=new Blob([data.csv_text],{type:'text/csv'}); const url=URL.createObjectURL(blob); dlCsv.href=url; dlCsv.classList.remove('hidden'); dlXlsx.onclick=()=>{const wb=XLSX.utils.book_new(); const ws=XLSX.utils.csv_to_sheet(data.csv_text); XLSX.utils.book_append_sheet(wb,ws,'Cleaned'); XLSX.writeFile(wb,'cleaned.xlsx');}; dlXlsx.classList.remove('hidden');
const rows=data.preview_rows||[]; tHead.innerHTML=''; tBody.innerHTML=''; if(rows.length){ const cols=Object.keys(rows[0]); const tr=document.createElement('tr'); cols.forEach(c=>{const th=document.createElement('th'); th.className='text-left p-2 border-b border-slate-800'; th.textContent=c; tr.appendChild(th)}); tHead.appendChild(tr); rows.forEach(r=>{const trb=document.createElement('tr'); cols.forEach(c=>{const td=document.createElement('td'); td.className='p-2'; td.textContent=r[c]??''; trb.appendChild(td)}); tBody.appendChild(trb); } ); preview.classList.remove('hidden'); }
chart.data.labels.push(new Date().toLocaleTimeString()); chart.data.datasets[0].data.push(s.invalid_emails); chart.data.datasets[1].data.push(s.invalid_phones); chart.data.datasets[2].data.push(s.duplicates_removed); chart.update();
});
</script>
</body>
</html>
