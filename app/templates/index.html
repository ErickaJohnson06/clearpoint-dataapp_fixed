<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ClearPoint DataApp â€” Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-cyan-500 flex items-center justify-center font-black text-slate-900">CP</div>
        <div>
          <h1 class="text-2xl font-bold">ClearPoint Data Services</h1>
          <p class="text-slate-400 text-sm -mt-0.5">Accuracy You Can Trust</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggleTheme" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Toggle theme</button>
        <a href="/docs" class="px-3 py-1 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-sm">API Docs</a>
      </div>
    </header>

    <section class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-4">Process a CSV</h2>
        <form id="form" class="grid md:grid-cols-2 gap-4" enctype="multipart/form-data">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">CSV file</label>
            <input class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-600 file:text-white file:cursor-pointer rounded-lg bg-slate-950 border border-slate-800 p-2" type="file" name="file" accept=".csv" required />
            <p id="headersHint" class="text-xs text-slate-400 mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Email columns</label>
            <input class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2" type="text" name="email_columns" placeholder="email,alt_email"/>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Phone columns</label>
            <input class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2" type="text" name="phone_columns" placeholder="phone,cell"/>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">Key columns for dedupe</label>
            <input class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2" type="text" name="key_columns" placeholder="email,phone"/>
          </div>
          <div class="md:col-span-2 flex gap-3">
            <button class="px-4 py-2 rounded-xl bg-cyan-600 hover:bg-cyan-500" type="submit" id="processBtn">Process</button>
            <a id="downloadCsv" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" download="cleaned.csv">Download CSV</a>
            <button id="downloadXlsx" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" type="button">Download Excel</button>
            <button id="openReport" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" type="button">Open Report</button>
            <button id="printReport" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700" type="button">Save as PDF</button>
          </div>
        </form>

        <div id="summary" class="hidden mt-6 bg-slate-950 border border-slate-800 rounded-xl p-4"></div>

        <div id="preview" class="hidden mt-6">
          <h3 class="font-semibold mb-2">Preview (first 10 rows)</h3>
          <div class="overflow-auto border border-slate-800 rounded-xl">
            <table id="previewTable" class="min-w-full text-sm">
              <thead class="bg-slate-900"></thead>
              <tbody class="divide-y divide-slate-900"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-4">Analytics</h2>
        <canvas id="analyticsChart" height="260"></canvas>
        <p class="text-xs text-slate-400 mt-2">Aggregated from this browser's session.</p>
      </div>
    </section>

    <section id="report" class="hidden print:block max-w-4xl mx-auto mt-8 bg-white text-slate-900 rounded-2xl p-8">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-cyan-600 flex items-center justify-center font-black text-white">CP</div>
          <div>
            <div class="text-xl font-bold">ClearPoint Data Services</div>
            <div class="text-slate-600 text-sm">Accuracy You Can Trust</div>
          </div>
        </div>
        <div class="text-right text-sm text-slate-500">
          <div id="reportDate"></div>
          <div>clearpoint-dataapp</div>
        </div>
      </div>
      <h2 class="text-2xl font-bold mb-2">Data Cleaning Summary</h2>
      <p class="text-slate-600 mb-6">This report summarizes the results of your latest CSV processing.</p>
      <div id="reportSummary" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-6"></div>
      <h3 class="text-lg font-semibold mb-2">Columns</h3>
      <div id="reportColumns" class="text-sm text-slate-700 mb-6"></div>
      <h3 class="text-lg font-semibold mb-2">Sample Rows</h3>
      <div class="overflow-auto border rounded-xl">
        <table id="reportTable" class="min-w-full text-sm">
          <thead class="bg-slate-100"></thead>
          <tbody class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const html = document.documentElement;
    const toggleThemeBtn = document.getElementById('toggleTheme');
    const savedTheme = localStorage.getItem('cp-theme') || 'dark';
    if (savedTheme === 'light') html.classList.remove('dark'); else html.classList.add('dark');
    toggleThemeBtn.onclick = () => {
      if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('cp-theme','light'); }
      else { html.classList.add('dark'); localStorage.setItem('cp-theme','dark'); }
    };

    const form = document.getElementById('form');
    const headersHint = document.getElementById('headersHint');
    const summaryBox = document.getElementById('summary');
    const preview = document.getElementById('preview');
    const tHead = document.querySelector('#previewTable thead');
    const tBody = document.querySelector('#previewTable tbody');
    const dlCsv = document.getElementById('downloadCsv');
    const dlXlsx = document.getElementById('downloadXlsx');
    const openReportBtn = document.getElementById('openReport');
    const printReportBtn = document.getElementById('printReport');
    const report = document.getElementById('report');
    const reportDate = document.getElementById('reportDate');
    const reportSummary = document.getElementById('reportSummary');
    const reportColumns = document.getElementById('reportColumns');
    const reportHead = document.querySelector('#reportTable thead');
    const reportBody = document.querySelector('#reportTable tbody');

    const ctx = document.getElementById('analyticsChart');
    const analyticsData = JSON.parse(localStorage.getItem('cp-analytics') || '{"labels":[],"invalidEmails":[],"invalidPhones":[],"duplicatesRemoved":[]}');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: analyticsData.labels,
        datasets: [
          { label: 'Invalid emails', data: analyticsData.invalidEmails },
          { label: 'Invalid phones', data: analyticsData.invalidPhones },
          { label: 'Duplicates removed', data: analyticsData.duplicatesRemoved },
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
    function updateChart(label, invalidEmails, invalidPhones, duplicatesRemoved) {
      analyticsData.labels.push(label);
      analyticsData.invalidEmails.push(invalidEmails);
      analyticsData.invalidPhones.push(invalidPhones);
      analyticsData.duplicatesRemoved.push(duplicatesRemoved);
      localStorage.setItem('cp-analytics', JSON.stringify(analyticsData));
      chart.update();
    }

    form.file.addEventListener('change', async () => {
      if (!form.file.files[0]) return;
      const text = await form.file.files[0].text();
      const firstLine = text.split(/\r?\n/)[0] || '';
      headersHint.textContent = firstLine ? 'Detected headers: ' + firstLine : '';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      summaryBox.classList.add('hidden'); preview.classList.add('hidden');
      dlCsv.classList.add('hidden'); dlXlsx.classList.add('hidden'); openReportBtn.classList.add('hidden'); printReportBtn.classList.add('hidden');

      const fd = new FormData(form);
      const res = await fetch('/api/process', { method: 'POST', body: fd });
      if (!res.ok) { alert('Processing failed'); return; }
      const data = await res.json();
      const s = data.summary;

      summaryBox.innerHTML = `<div class='grid grid-cols-2 md:grid-cols-3 gap-3 text-sm'>
        <div><span class='text-slate-400'>Rows in</span><div class='text-xl font-semibold'>${s.rows_in}</div></div>
        <div><span class='text-slate-400'>Rows out</span><div class='text-xl font-semibold'>${s.rows_out}</div></div>
        <div><span class='text-slate-400'>Duplicates removed</span><div class='text-xl font-semibold'>${s.duplicates_removed}</div></div>
        <div><span class='text-slate-400'>Invalid emails</span><div class='text-xl font-semibold'>${s.invalid_emails}</div></div>
        <div><span class='text-slate-400'>Invalid phones</span><div class='text-xl font-semibold'>${s.invalid_phones}</div></div>
        <div><span class='text-slate-400'>Columns</span><div class='text-sm break-all'>${(s.columns||[]).join(', ')}</div></div>
      </div>`;
      summaryBox.classList.remove('hidden');

      const csvBlob = new Blob([data.csv_text], { type: 'text/csv' });
      const csvUrl = URL.createObjectURL(csvBlob);
      dlCsv.href = csvUrl; dlCsv.classList.remove('hidden');
      dlXlsx.onclick = () => {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.csv_to_sheet(data.csv_text);
        XLSX.utils.book_append_sheet(wb, ws, 'Cleaned');
        XLSX.writeFile(wb, 'cleaned.xlsx');
      };
      dlXlsx.classList.remove('hidden');

      const rows = data.preview_rows || [];
      tHead.innerHTML = ''; tBody.innerHTML = '';
      if (rows.length) {
        const cols = Object.keys(rows[0]);
        const tr = document.createElement('tr');
        cols.forEach(c => {
          const th = document.createElement('th');
          th.className = 'text-left p-2 border-b border-slate-800';
          th.textContent = c;
          tr.appendChild(th);
        });
        tHead.appendChild(tr);
        rows.forEach(r => {
          const trb = document.createElement('tr');
          cols.forEach(c => {
            const td = document.createElement('td');
            td.className = 'p-2';
            td.textContent = r[c] ?? '';
            trb.appendChild(td);
          });
          tBody.appendChild(trb);
        });
        preview.classList.remove('hidden');
      }

      updateChart(new Date().toLocaleTimeString(), s.invalid_emails, s.invalid_phones, s.duplicates_removed);
      localStorage.setItem('cp-last-run', JSON.stringify(data));
      openReportBtn.classList.remove('hidden');
      printReportBtn.classList.remove('hidden');
    });

    function buildReport() {
      const data = JSON.parse(localStorage.getItem('cp-last-run') || 'null');
      if (!data) { alert('No recent run to report.'); return; }
      const s = data.summary;
      document.getElementById('reportDate').textContent = new Date().toLocaleString();
      document.getElementById('reportSummary').innerHTML = `
        <div><div class='text-slate-500'>Rows in</div><div class='text-xl font-semibold'>${s.rows_in}</div></div>
        <div><div class='text-slate-500'>Rows out</div><div class='text-xl font-semibold'>${s.rows_out}</div></div>
        <div><div class='text-slate-500'>Duplicates removed</div><div class='text-xl font-semibold'>${s.duplicates_removed}</div></div>
        <div><div class='text-slate-500'>Invalid emails</div><div class='text-xl font-semibold'>${s.invalid_emails}</div></div>
        <div><div class='text-slate-500'>Invalid phones</div><div class='text-xl font-semibold'>${s.invalid_phones}</div></div>
      `;
      document.getElementById('reportColumns').textContent = (s.columns || []).join(', ');

      const head = document.querySelector('#reportTable thead');
      const body = document.querySelector('#reportTable tbody');
      head.innerHTML = ''; body.innerHTML = '';
      const rows = data.preview_rows || [];
      if (rows.length) {
        const cols = Object.keys(rows[0]);
        const tr = document.createElement('tr');
        cols.forEach(c => {
          const th = document.createElement('th');
          th.className = 'text-left p-2 border-b';
          th.textContent = c;
          tr.appendChild(th);
        });
        head.appendChild(tr);
        rows.forEach(r => {
          const trb = document.createElement('tr');
          cols.forEach(c => {
            const td = document.createElement('td');
            td.className = 'p-2';
            td.textContent = r[c] ?? '';
            trb.appendChild(td);
          });
          body.appendChild(trb);
        });
      }
    }

    document.getElementById('openReport').onclick = () => {
      document.getElementById('report').classList.remove('hidden');
      buildReport();
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };
    document.getElementById('printReport').onclick = () => {
      const report = document.getElementById('report');
      if (report.classList.contains('hidden')) { report.classList.remove('hidden'); buildReport(); }
      window.print();
    };
  </script>
</body>
</html>
