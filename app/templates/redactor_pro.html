
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Redactor Pro â€” {{ brand.APP_NAME }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
<div class="max-w-5xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">Redactor Pro</h1>
    <a href="/" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Back</a>
  </header>
  <div class="grid md:grid-cols-3 gap-6">
    <div class="md:col-span-1 bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
      <label class="block text-sm font-semibold mb-1">Upload PDF or Image</label>
      <input id="file" type="file" accept=".pdf,.png,.jpg,.jpeg" class="w-full rounded-lg bg-slate-950 border border-slate-800 p-2"/>
      <div class="mt-3 flex gap-2">
        <button id="clear" class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700">Clear boxes</button>
        <button id="download" class="px-3 py-1 rounded bg-cyan-500 text-slate-900">Download</button>
      </div>
      <div id="thumbs" class="mt-3 flex gap-2 flex-wrap"></div>
    </div>
    <div class="md:col-span-2 bg-slate-900/50 border border-slate-800 rounded-2xl p-4 overflow-auto">
      <canvas id="c" width="800" height="1100" class="rounded-xl border border-slate-800 bg-black"></canvas>
    </div>
  </div>
</div>
<script>
const c=document.getElementById('c'); const ctx=c.getContext('2d');
let img=new Image(); let boxes=[]; let dragging=false; let start=null; let fileBlob=null; let pages=[]; let page=0; function draw(){ctx.clearRect(0,0,c.width,c.height); if(img.src) ctx.drawImage(img,0,0,c.width,c.height); ctx.strokeStyle='#06b6d4'; ctx.lineWidth=2; boxes.filter(b=>b.page===page).forEach(b=>{ctx.strokeRect(b.x,b.y,b.w,b.h); ctx.fillStyle='rgba(6,182,212,0.15)'; ctx.fillRect(b.x,b.y,b.w,b.h);}); }
c.onmousedown=e=>{ if(!img.src) return; dragging=true; const r=c.getBoundingClientRect(); start={x:e.clientX-r.left,y:e.clientY-r.top}; };
c.onmousemove=e=>{ if(!dragging) return; const r=c.getBoundingClientRect(); const x=e.clientX-r.left,y=e.clientY-r.top; draw(); ctx.setLineDash([6,4]); ctx.strokeStyle='#67e8f9'; ctx.strokeRect(start.x,start.y,x-start.x,y-start.y); ctx.setLineDash([]); };
c.onmouseup=e=>{ if(!dragging) return; dragging=false; const r=c.getBoundingClientRect(); const x=e.clientX-r.left,y=e.clientY-r.top; boxes.push({page, x:Math.min(start.x,x), y:Math.min(start.y,y), w:Math.abs(x-start.x), h:Math.abs(y-start.y)}); draw(); };
document.getElementById('clear').onclick=()=>{ boxes=boxes.filter(b=>b.page!==page); draw(); };
document.getElementById('file').onchange=async(e)=>{ const f=e.target.files[0]; if(!f) return; fileBlob=f; const isPDF=f.name.toLowerCase().endsWith('.pdf'); const t=document.getElementById('thumbs'); t.innerHTML=''; boxes=[];
  if(isPDF){ const fd=new FormData(); fd.append('file', f); const res=await fetch('/api/preview_pdf',{method:'POST',body:fd}); const data=await res.json(); pages = data.pages.map(b64=>'data:image/png;base64,'+b64); pages.forEach((src,i)=>{ const im=document.createElement('img'); im.src=src; im.className='w-20 h-28 object-cover rounded border border-slate-800 cursor-pointer'; im.onclick=()=>{page=i; img.src=src; img.onload=()=>draw();}; t.appendChild(im); }); page=0; img.src=pages[0]; img.onload=()=>draw(); }
  else { pages=[]; const url=URL.createObjectURL(f); img.src=url; img.onload=()=>draw(); }
};
document.getElementById('download').onclick=async()=>{ if(!fileBlob){ alert('Upload a file first'); return; } const fd=new FormData(); const rects=boxes.filter(b=> pages.length? true : b.page===0); fd.append('file', fileBlob); fd.append('rects_json', JSON.stringify(rects)); const endpoint = fileBlob.name.toLowerCase().endsWith('.pdf') ? '/api/redact_pdf' : '/api/redact_image'; const res=await fetch(endpoint,{method:'POST',body:fd}); if(!res.ok){ alert('Redaction failed'); return; } const blob=await res.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = endpoint.includes('pdf')? 'redacted.pdf':'redacted.png'; a.click(); };
</script>
</body>
</html>
